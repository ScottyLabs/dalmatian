name: Sync priority labels to project field

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request:
    types: [opened, labeled, unlabeled]
  workflow_dispatch:

permissions:
  issues: write
  repository-projects: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const priorityMap = {
              "high priority": "P0",
              "medium priority": "P1",
              "low priority": "P2",
            };

            const item =
              context.payload.issue ?? context.payload.pull_request;

            const labels = item.labels.map(l => l.name);
            const priorityLabel = labels.find(l => priorityMap[l]);

            if (!priorityLabel) {
              console.log('No priority label found');
              return;
            }

            const priorityValue = priorityMap[priorityLabel];
            console.log(`Found priority label: ${priorityLabel} â†’ ${priorityValue}`);

            // Get organization and repository info
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const itemId = item.node_id;

            // Find the project item
            const projectQuery = `
              query($owner: String!, $repo: String!, $itemId: ID!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: ${item.number}) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          field(name: "Priority") {
                            ... on ProjectV2SingleSelectField {
                              id
                              options {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            let projectData;
            try {
              projectData = await github.graphql(projectQuery, {
                owner,
                repo,
                itemId
              });
            } catch (error) {
              console.error('Error fetching project data:', error);
              return;
            }

            const projectItems = projectData.repository.issue.projectItems.nodes;
            if (!projectItems || projectItems.length === 0) {
              console.log('Issue not linked to any project');
              return;
            }

            // Update each project the issue is linked to
            for (const projectItem of projectItems) {
              const priorityField = projectItem.project.field;
              if (!priorityField) {
                console.log(`Project "${projectItem.project.title}" has no Priority field`);
                continue;
              }

              const option = priorityField.options.find(opt => opt.name === priorityValue);
              if (!option) {
                console.log(`Priority value "${priorityValue}" not found in project "${projectItem.project.title}"`);
                continue;
              }

              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              try {
                await github.graphql(updateMutation, {
                  projectId: projectItem.project.id,
                  itemId: projectItem.id,
                  fieldId: priorityField.id,
                  optionId: option.id
                });
                console.log(`Updated Priority to "${priorityValue}" in project "${projectItem.project.title}"`);
              } catch (error) {
                console.error(`Error updating project "${projectItem.project.title}":`, error);
              }
            }

